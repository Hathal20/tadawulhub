# app.py
# This is the main backend file. It uses Flask to define API endpoints.
# The frontend will call these endpoints to get data.
# We also enable CORS so the frontend (running on a different port) can access it.



from flask import Flask, render_template, jsonify, request, redirect, url_for, flash
import yfinance as yf
import pandas as pd
import pandas_ta as ta
import os
import requests
from bs4 import BeautifulSoup
from datetime import datetime, timedelta
import numpy as np
import smtplib
from email.mime.text import MIMEText
from flask import Flask
from flask_sqlalchemy import SQLAlchemy

from flask_compress import Compress

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)


compress = Compress()
compress.init_app(app)

# Add this:
with app.app_context():
    db.create_all()

class User(db.Model):
    id    = db.Column(db.Integer, primary_key=True)
    name  = db.Column(db.String(120), nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)

import logging

# tell Flaskโs logger to show DEBUG messages
app.logger.setLevel(logging.DEBUG)

app.secret_key = 'H8563athaL4$H8563athaL4$'  # Needed for flash messages in signup form

# Base symbols
symbols_path = os.path.join(os.path.dirname(__file__), 'symbols.txt')
with open(symbols_path, 'r') as f:
    base_symbols = [line.strip() for line in f if line.strip()]

# S&P 500 symbols
sp500_url = "https://en.wikipedia.org/wiki/List_of_S%26P_500_companies"
sp_res = requests.get(sp500_url)
sp_soup = BeautifulSoup(sp_res.text, 'lxml')
sp500_table = sp_soup.find('table', {'id': 'constituents'})
sp500_symbols = []
if sp500_table:
    rows = sp500_table.find_all('tr')[1:]
    for row in rows:
        cols = row.find_all('td')
        if len(cols) > 1:
            symbol = cols[0].text.strip()
            name = cols[1].text.strip()
            sp500_symbols.append((symbol, name))


# Tadawul stocks by sector (code and name, no .SR shown here)
# Format: sector: [(name, code), ...]
# ----------------------------------------
# Tadawul stocks by sector (code and name, no .SR shown here)
tadawul_sectors = {
    "ูุคุดุฑ ุงูุณูู ุงูุณุนูุฏู - ุชุงุณู": [("TASI Tadawul", "^TASI"),],
    "ุงูุทุงูุฉ": [
        ("ุงููุตุงูู", "2030"),
        ("ุงุฑุงููู ุงูุณุนูุฏูุฉ", "2222"),
        ("ุจุชุฑูุฑุงุจุบ", "2380"),
        ("ุงูุญูุฑ ุงูุนุฑุจูุฉ", "2381"),
        ("ุฃุฏูุณ", "2382"),
        ("ุจุญุฑู", "4030"),
        ("ุงูุฏุฑูุณ", "4200"),
    ],
    "ุงูููุงุฏ ุงูุฃุณุงุณูุฉ": [
        ("ุชูููู", "1201"), ("ูุจูู", "1202"), ("ุจู ุณู ุขู", "1210"), ("ูุนุงุฏู", "1211"),
        ("ุฃุณูุงู", "1301"), ("ุงูููุงูุฉููุญุฏูุฏ", "1304"), ("ุฃูุงุจูุจ ุงูุณุนูุฏูุฉ", "1320"), ("ุฃูุงุจูุจ ุงูุดุฑู", "1321"),
        ("ุฃูุงู", "1322"), ("ูููุงููู", "2001"), ("ุณุงุจู", "2010"), ("ุณุงุจู ูููุบุฐูุงุช ุงูุฒุฑุงุนูุฉ", "2020"),
        ("ุงูุชุตููุน", "2060"), ("ุฌุจุณูู", "2090"), ("ุฒุฌุงุฌ", "2150"), ("ุงููุฌูู", "2170"),
        ("ููุจูู", "2180"), ("ุฃูุงุจูุจ", "2200"), ("ููุงุก ูููููุงููุงุช", "2210"), ("ูุนุฏููุฉ", "2220"),
        ("ููุจุฑูู", "2223"), ("ุงูุฒุงูู ููุตูุงุนุฉ", "2240"), ("ุงููุฌููุนุฉ ุงูุณุนูุฏูุฉ", "2250"), ("ููุณุงุจ", "2290"),
        ("ุตูุงุนุฉ ุงููุฑู", "2300"), ("ุณุจููู", "2310"), ("ุงููุชูุฏูุฉ", "2330"), ("ููุงู ุงูุณุนูุฏูุฉ", "2350"),
        ("ููุฎุงุฑูุฉ", "2360"), ("ุฃุณููุช ูุฌุฑุงู", "3002"), ("ุฃุณููุช ุงููุฏููุฉ", "3003"), ("ุฃุณููุช ุงูุดูุงููุฉ", "3004"),
        ("ุฃุณููุช ุฃู ุงููุฑู", "3005"), ("ุงููุงุญุฉ", "3007"), ("ุงููุซูุฑู", "3008"), ("ุฃุณููุช ุงูุนุฑุจูุฉ", "3010"),
        ("ุฃุณููุช ุงูููุงูุฉ", "3020"), ("ุฃุณููุช ุงูุณุนูุฏูุฉ", "3030"), ("ุฃุณููุช ุงููุตูู", "3040"), ("ุฃุณููุช ุงูุฌููุจ", "3050"),
        ("ุฃุณููุช ููุจุน", "3060"), ("ุฃุณููุช ุงูุดุฑููุฉ", "3080"), ("ุฃุณููุช ุชุจูู", "3090"), ("ุฃุณููุช ุงูุฌูู", "3091"),
        ("ุฃุณููุช ุงูุฑูุงุถ", "3092")
    ],
    "ุงูุณูุน ุงูุฑุฃุณูุงููุฉ": [
        ("ุงุณุชุฑุง ุงูุตูุงุนูุฉ", "1212"), ("ุดุงูุฑ", "1214"), ("ุจูุงู", "1302"), ("ุตูุงุนุงุช ููุฑุจุงุฆูุฉ", "1303"),
        ("ุงูุฎุฒู ุงูุณุนูุฏู", "2040"), ("ููุงุจูุงุช ุงูุณุนูุฏูุฉ", "2110"), ("ุฃููุงูุชูุช", "2160"),
        ("ุงูุจุงุจุทูู", "2320"), ("ูุณู", "2370"), ("ุจุงุชู", "4110"), ("ุณููู", "4140"),
        ("ุงูุนูุฑุงู", "4141"), ("ูุงุจูุงุช ุงูุฑูุงุถ", "4142"), ("ุชุงููู", "4143")
    ],
    "ุงูุฎุฏูุงุช ุงูุชุฌุงุฑูุฉ ูุงูููููุฉ": [
        ("ุดุฑูุฉ ููุงุฑุฉ ููููุงุฑุฏ ุงูุจุดุฑูุฉ", "1831"), ("ุดุฑูุฉ ุตุฏุฑ ููุฎุฏูุงุช ุงูููุฌุณุชูุฉ", "1832"),
        ("ุดุฑูุฉ ุงูููุงุฑุฏ ููููู ุงูุจุดุฑูุฉ", "1833"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ูุญููู ุงูููู ุงูุจุดุฑูุฉ", "1834"),
        ("ุดุฑูุฉ ุชูููู ููููุงุฑุฏ ุงูุจุดุฑูุฉ", "1835"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุทุจุงุนุฉ ูุงูุชุบููู", "4270"),
        ("ุดุฑูุฉ ูุงุชุฑููู ููุชูููู ุงููุงุจุถุฉ", "6004")
    ],
    "ุงูููู": [
        ("ุดุฑูุฉ ุงูุจูู ุงูุชุญุชูุฉ ุงููุณุชุฏุงูุฉ ุงููุงุจุถุฉ", "2190"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุฎุฏูุงุช ุงูุฃุฑุถูุฉ", "4031"),
        ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููููู ุงูุฌูุงุนู", "4040"), ("ุงูุดุฑูุฉ ุงููุชุญุฏุฉ ุงูุฏูููุฉ ููููุงุตูุงุช", "4260"),
        ("ุดุฑูุฉ ุฐูุจ ูุชุฃุฌูุฑ ุงูุณูุงุฑุงุช", "4261"), ("ุดุฑูุฉ ูููู ููุชุฃุฌูุฑ", "4262"),
        ("ุดุฑูุฉ ุณุงู ุงูุณุนูุฏูุฉ ููุฎุฏูุงุช ุงูููุฌุณุชูุฉ", "4263")
    ],
    "ุงูุณูุน ุทูููุฉ ุงูุงุฌู": [
        ("ุดุฑูุฉ ูุณูุฌ ุงูุนุงูููุฉ ุงูุชุฌุงุฑูุฉ", "1213"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุชูููุฉ ุงูุตูุงุนูุฉ", "2130"),
        ("ุดุฑูุฉ ุงุฑุชููุณ ููุงุณุชุซูุงุฑ ุงูุตูุงุนู", "2340"), ("ุดุฑูุฉ ูุงุฒูุฑุฏู ูููุฌููุฑุงุช", "4011"),
        ("ุดุฑูุฉ ุซูุจ ุงูุฃุตูู", "4012"), ("ูุฌููุนุฉ ูุชูุญู ุงููุงุจุถุฉ", "4180")
    ],
    "ุงูุฎุฏูุงุช ุงูุฅุณุชููุงููุฉ": [
        ("ูุฌููุนุฉ ุณูุฑุง ุงููุงุจุถุฉ", "1810"), ("ุดุฑูุฉ ูุฌููุนุฉ ุจุงู ุงููุงุจุถุฉ", "1820"), ("ุดุฑูุฉ ูุฌุงู ููุฑูุงุถุฉ", "1830"),
        ("ุดุฑูุฉ ุงููุดุฑูุนุงุช ุงูุณูุงุญูุฉ", "4170"),
        ("ุดุฑูุฉ ุงูุฎููุฌ ููุชุฏุฑูุจ ูุงูุชุนููู", "4290"), ("ุงูุดุฑูุฉ ุงููุทููุฉ ููุชุฑุจูุฉ ู ุงูุชุนููู", "4291"),
        ("ุดุฑูุฉ ุนุทุงุก ุงูุชุนููููุฉ", "4292"),
        ("ุดุฑูุฉ ูุฑูู ููุฎุฏูุงุช ุงูุบุฐุงุฆูุฉ", "6002"), ("ุดุฑูุฉ ุฑูุฏุงู ุงูุบุฐุงุฆูุฉ", "6012"),
        ("ุดุฑูุฉ ุงูุฃุนูุงู ุงูุชุทููุฑูุฉ ุงูุบุฐุงุฆูุฉ", "6013"),
        ("ุดุฑูุฉ ุงูุขูุงุฑ ุงูุบุฐุงุฆูุฉ", "6014"), ("ุดุฑูุฉ ุฃูุฑููุงูุง ูููุทุงุนู ุงูุนุงูููุฉ ุจู ุฅู ุณู - ุดุฑูุฉ ุฃุฌูุจูุฉ", "6015"),
        ("ุดุฑูุฉ ูุทุงุนู ุจูุช ุงูุดุทูุฑุฉ ูููุฌุจุงุช ุงูุณุฑูุนุฉ", "6016")
    ],
    "ุงูุฅุนูุงู ูุงูุชุฑููู": [
        ("ุดุฑูุฉ ุชูุงูุฉ ููุฅุนูุงู ูุงูุนูุงูุงุช ุงูุนุงูุฉ", "4070"), ("ุงูุดุฑูุฉ ุงูุนุฑุจูุฉ ููุชุนูุฏุงุช ุงููููุฉ", "4071"),
        ("ุดุฑูุฉ ูุฌููุนุฉ ุฅู ุจู ุณู", "4072"), ("ุงููุฌููุนุฉ ุงูุณุนูุฏูุฉ ููุฃุจุญุงุซ ูุงูุฅุนูุงู", "4210")
    ],
    "ุชุฌุฒุฆุฉ ูุชูุฒูุน ุงูุณูุน ุงูููุงููุฉ": [
        ("ุงูุดุฑูุฉ ุงููุชุญุฏุฉ ููุฅููุชุฑูููุงุช", "4003"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุนุฏุฏ ูุงูุฃุฏูุงุช", "4008"),
        ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ูุฎุฏูุงุช ุงูุณูุงุฑุงุช ูุงููุนุฏุงุช", "4050"), ("ุดุฑูุฉ ุจุงุนุธูู ุงูุชุฌุงุฑูุฉ", "4051"),
        ("ุดุฑูุฉ ุฌุฑูุฑ ููุชุณููู", "4190"), ("ุดุฑูุฉ ุนุจุฏ ุงููู ุณุนุฏ ูุญูุฏ ุฃุจู ูุนุทู ููููุชุจุงุช", "4191"),
        ("ุดุฑูุฉ ูุชุงุฌุฑ ุงูุณูู ููุชูููุฉ ูุงูุงุณุชุซูุงุฑ", "4192"), ("ุดุฑูุฉ ููุงุฒ ุนุจุฏุงูุนุฒูุฒ ุงูุญููุฑ ูุดุฑูุงู", "4240")
    ],
    "ุชุฌุฒุฆุฉ ูุชูุฒูุน ุงูุณูุน ุงูุงุณุชููุงููุฉ": [
        ("ุดุฑูุฉ ุฃุณูุงู ุนุจุฏุงููู ุงูุนุซูู", "4001"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุชุณููู", "4006"),
        ("ูุฌููุนุฉ ุฃูุนุงู ุงูุฏูููุฉ ุงููุงุจุถุฉ", "4061"),
        ("ุดุฑูุฉ ุซูุงุฑ ุงูุชูููุฉ ุงููุงุจุถุฉ", "4160"), ("ุดุฑูุฉ ุจู ุฏุงูุฏ ุงููุงุจุถุฉ", "4161"), ("ุดุฑูุฉ ุงูููุฌู ููุฃุบุฐูุฉ", "4162"),
        ("ุดุฑูุฉ ุงูุฏูุงุก ููุฎุฏูุงุช ุงูุทุจูุฉ", "4163"), ("ุดุฑูุฉ ุงูููุฏู ุงูุทุจูุฉ", "4164")
    ],
    "ุฅูุชุงุฌ ุงูุฃุบุฐูุฉ": [
        ("ูุฌููุนุฉ ุตุงูููุง", "2050"), ("ุดุฑูุฉ ููุฑุฉ ููุตูุงุนุฉ ูุงูุชูููุฉ", "2100"),
        ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ูููุชุฌุงุช ุงูุฃูุจุงู ูุงูุฃุบุฐูุฉ", "2270"), ("ุดุฑูุฉ ุงููุฑุงุนู", "2280"),
        ("ุดุฑูุฉ ุงูุชูููุฉ ุงูุบุฐุงุฆูุฉ", "2281"), ("ุดุฑูุฉ ููู ููููุงู", "2282"), ("ุดุฑูุฉ ุงููุทุงุญู ุงูุฃููู", "2283"),
        ("ุดุฑูุฉ ุงููุทุงุญู ุงูุญุฏูุซุฉ ููููุชุฌุงุช ุงูุบุฐุงุฆูุฉ", "2284"), ("ุดุฑูุฉ ุงููุทุงุญู ุงูุนุฑุจูุฉ ููููุชุฌุงุช ุงูุบุฐุงุฆูุฉ", "2285"),
        ("ุดุฑูุฉ ุงููุทุงุญู ุงูุฑุงุจุนุฉ", "2286"),
        ("ุดุฑูุฉ ุณูุงุฏ ุงููุงุจุถุฉ", "4080"), ("ุดุฑูุฉ ุญููุงูู ุฅุฎูุงู", "6001"), ("ุงูุดุฑูุฉ ุงููุทููุฉ ููุชูููุฉ ุงูุฒุฑุงุนูุฉ", "6010"),
        ("ุดุฑูุฉ ุงููุตูู ุงููุงุจุถุฉ ููุงุณุชุซูุงุฑ", "6020"),
        ("ุดุฑูุฉ ุชุจูู ููุชูููุฉ ุงูุฒุฑุงุนูุฉ", "6040"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุฃุณูุงู", "6050"), ("ุดุฑูุฉ ุงูุดุฑููุฉ ููุชูููุฉ", "6060"),
        ("ุดุฑูุฉ ุงูุฌูู ุงูุฒุฑุงุนูุฉ", "6070"),
        ("ุดุฑูุฉ ุฌุงุฒุงู ููุชูููุฉ ูุงูุงุณุชุซูุงุฑ", "6090")
    ],
    "ุงูููุชุฌุงุช ุงูููุฒููุฉ ู ุงูุดุฎุตูุฉ": [
        ("ุดุฑูุฉ ุงููุงุฌุฏ ููุนูุฏ", "4165")
    ],
    "ุงูุฑุนุงูุฉ ุงูุตุญูุฉ": [
        ("ุดุฑูุฉ ุฃูุงู ููุฅุณุชุซูุงุฑ", "2140"), ("ุงูุดุฑูุฉ ุงูููููุงุฆูุฉ ุงูุณุนูุฏูุฉ ุงููุงุจุถุฉ", "2230"),
        ("ุดุฑูุฉ ุงูููุงุณุงุฉ ููุฎุฏูุงุช ุงูุทุจูุฉ", "4002"), ("ุดุฑูุฉ ุฏูู ููุฎุฏูุงุช ุงูุตุญูุฉ", "4004"),
        ("ุงูุดุฑูุฉ ุงููุทููุฉ ููุฑุนุงูุฉ ุงูุทุจูุฉ", "4005"), ("ุดุฑูุฉ ุงูุญูุงุฏู ุงููุงุจุถุฉ", "4007"),
        ("ุดุฑูุฉ ุงูุดุฑู ุงูุฃูุณุท ููุฑุนุงูุฉ ุงูุตุญูุฉ", "4009"),
        ("ูุฌููุนุฉ ุงูุฏูุชูุฑ ุณูููุงู ุงูุญุจูุจ ููุฎุฏูุงุช ุงูุทุจูุฉ", "4013"), ("ุดุฑูุฉ ุฏุงุฑ ุงููุนุฏุงุช ุงูุทุจูุฉ ูุงูุนูููุฉ", "4014"),
        ("ุดุฑูุฉ ูุณุชุดูู ุงูุฏูุชูุฑ ุณูููุงู ุนุจุฏุงููุงุฏุฑ ูููู", "4017")
    ],
    "ุงูุงุฏููุฉ": [
        ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุตูุงุนุงุช ุงูุฏูุงุฆูุฉ ูุงููุณุชูุฒูุงุช ุงูุทุจูุฉ", "2070"), ("ุดุฑูุฉ ูุตูุน ุฌูุฌูู ููุฃุฏููุฉ", "4015"),
        ("ุดุฑูุฉ ุงูุดุฑู ุงูุฃูุณุท ููุตูุงุนุงุช ุงูุฏูุงุฆูุฉ", "4016")
    ],
    "ุงูุจููู": [
        ("ุจูู ุงูุฑูุงุถ", "1010"), ("ุจูู ุงูุฌุฒูุฑุฉ", "1020"), ("ุงูุจูู ุงูุณุนูุฏู ููุฅุณุชุซูุงุฑ", "1030"),
        ("ุงูุจูู ุงูุณุนูุฏู ุงููุฑูุณู", "1050"),
        ("ุงูุจูู ุงูุณุนูุฏู ุงูุฃูู", "1060"), ("ุงูุจูู ุงูุนุฑุจู ุงููุทูู", "1080"), ("ูุตุฑู ุงูุฑุงุฌุญู", "1120"),
        ("ุจูู ุงูุจูุงุฏ", "1140"),
        ("ูุตุฑู ุงูุฅููุงุก", "1150"), ("ุงูุจูู ุงูุฃููู ุงูุณุนูุฏู", "1180")
    ],
    "ุงูุฎุฏูุงุช ุงููุงููู": [
        ("ุดุฑูุฉ ูุฌููุนุฉ ุชุฏุงูู ุงูุณุนูุฏูุฉ ุงููุงุจุถุฉ", "1111"), ("ุดุฑูุฉ ุฃููุงู ุงูุนุงูููุฉ ููุชูููู", "1182"),
        ("ุดุฑูุฉ ุณูู ููุชูููู", "1183"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููุตูุงุนุงุช ุงููุชุทูุฑุฉ", "2120"),
        ("ุดุฑูุฉ ุงููุงููุงุช ููุชูููู", "4081"), ("ุดุฑูุฉ ุงููุฑุงุจุญุฉ ุงููุฑูุฉ ููุชูููู", "4082"),
        ("ุงูุดุฑูุฉ ุงููุชุญุฏุฉ ุงูุฏูููุฉ ุงููุงุจุถุฉ", "4083"), ("ุดุฑูุฉ ุงูุจุงุญุฉ ููุฅุณุชุซูุงุฑ ูุงูุชูููุฉ", "4130"),
        ("ุดุฑูุฉ ุงูููููุฉ ุงููุงุจุถุฉ", "4280")
    ],
    "ุงูุชุฃููู": [
        ("ุงูุดุฑูุฉ ุงูุชุนุงูููุฉ ููุชุฃููู", "8010"), ("ุดุฑูุฉ ุงูุฌุฒูุฑุฉ ุชูุงูู ุชุนุงููู", "8012"),
        ("ุดุฑูุฉ ููุงุฐ ููุชุฃููู ุงูุชุนุงููู", "8020"),
        ("ุดุฑูุฉ ุงููุชูุณุท ูุงูุฎููุฌ ููุชุฃููู ูุฅุนุงุฏุฉ ุงูุชุฃููู ุงูุชุนุงููู", "8030"), ("ุดุฑูุฉ ูุชูุงููุฉ ููุชุฃููู", "8040"),
        ("ุดุฑูุฉ ุณูุงูุฉ ููุชุฃููู ุงูุชุนุงููู", "8050"), ("ุดุฑูุฉ ููุงุก ููุชุฃููู ุงูุชุนุงููู", "8060"),
        ("ุดุฑูุฉ ุงูุฏุฑุน ุงูุนุฑุจู ููุชุฃููู ุงูุชุนุงููู", "8070"), ("ุงูุดุฑูุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ ููุชุฃููู ุงูุชุนุงููู", "8100"),
        ("ุดุฑูุฉ ุฅุชุญุงุฏ ุงูุฎููุฌ ุงูุฃูููุฉ ููุชุฃููู ุงูุชุนุงููู", "8120"),
        ("ุงููุฌููุนุฉ ุงููุชุญุฏุฉ ููุชุฃููู ุงูุชุนุงููู", "8150"), ("ุดุฑูุฉ ุงูุชุฃููู ุงูุนุฑุจูุฉ ุงูุชุนุงูููุฉ", "8160"),
        ("ุดุฑูุฉ ุงูุงุชุญุงุฏ ููุชุฃููู ุงูุชุนุงููู", "8170"), ("ุดุฑูุฉ ุงูุตูุฑ ููุชุฃููู ุงูุชุนุงููู", "8180"),
        ("ุงูุดุฑูุฉ ุงููุชุญุฏุฉ ููุชุฃููู ุงูุชุนุงููู", "8190"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ูุฅุนุงุฏุฉ ุงูุชุฃููู", "8200"),
        ("ุดุฑูุฉ ุจูุจุง ุงูุนุฑุจูุฉ ููุชุฃููู ุงูุชุนุงููู", "8210"), ("ุดุฑูุฉ ุงูุฑุงุฌุญู ููุชุฃููู ุงูุชุนุงููู", "8230"),
        ("ุดุฑูุฉ ุชูุดุจ ุงูุนุฑุจูุฉ ููุชุฃููู ุงูุชุนุงููู", "8240"), ("ูุฌููุนุฉ ุงูุฎููุฌ ููุชุฃููู", "8250"),
        ("ุงูุดุฑูุฉ ุงูุฎููุฌูุฉ ุงูุนุงูุฉ ููุชุฃููู ุงูุชุนุงููู", "8260"), ("ุดุฑูุฉ ุจุฑูุฌ ููุชุฃููู ุงูุชุนุงููู", "8270"),
        ("ุดุฑูุฉ ูููุง ููุชุฃููู", "8280"), ("ุงูุดุฑูุฉ ุงููุทููุฉ ููุชุฃููู", "8300"), ("ุดุฑูุฉ ุฃูุงูุฉ ููุชุฃููู ุงูุชุนุงููู", "8310"),
        ("ุดุฑูุฉ ุนูุงูุฉ ุงูุณุนูุฏูุฉ ููุชุฃููู ุงูุชุนุงููู", "8311"),
        ("ุดุฑูุฉ ุฑุณู ูุชูููุฉ ุงููุนูููุงุช", "8313")
    ],
    "ุงูุชุทุจููุงุช ูุฎุฏูุงุช ุงูุชูููุฉ": [
        ("ุดุฑูุฉ ุงููุนูุฑ ูุฃูุธูุฉ ุงููุนูููุงุช", "7200"), ("ุดุฑูุฉ ุจุญุฑ ุงูุนุฑุจ ูุฃูุธูุฉ ุงููุนูููุงุช", "7201"),
        ("ุงูุดุฑูุฉ ุงูุนุฑุจูุฉ ูุฎุฏูุงุช ุงูุฅูุชุฑูุช ูุงูุงุชุตุงูุงุช", "7202"), ("ุดุฑูุฉ ุนูู", "7203"),
        ("ุดุฑูุฉ ุงูุนุฑุถ ุงููุชูู ููุฎุฏูุงุช ุงูุชุฌุงุฑูุฉ", "7204")
    ],
    "ุงูุฅุชุตุงูุงุช": [
        ("ุดุฑูุฉ ุงูุฅุชุตุงูุงุช ุงูุณุนูุฏูุฉ", "7010"), ("ุดุฑูุฉ ุฅุชุญุงุฏ ุฅุชุตุงูุงุช", "7020"),
        ("ุดุฑูุฉ ุงูุฅุชุตุงูุงุช ุงููุชูููุฉ ุงูุณุนูุฏูุฉ", "7030"), ("ุดุฑูุฉ ุฅุชุญุงุฏ ุนุฐูุจ ููุฅุชุตุงูุงุช", "7040")
    ],
    "ุงููุฑุงูู ุงูุนุงูุฉ": [
        ("ุดุฑูุฉ ุงูุบุงุฒ ูุงูุชุตููุน ุงูุฃูููุฉ", "2080"), ("ุดุฑูุฉ ุงูุฎุฑูู ูุชูููุฉ ุงูููุงู ูุงูุทุงูุฉ", "2081"),
        ("ุดุฑูุฉ ุฃููุง ุจุงูุฑ", "2082"), ("ุดุฑูุฉ ูุฑุงูู ุงูููุฑุจุงุก ูุงูููุงู ุจุงูุฌุจูู ูููุจุน", "2083"),
        ("ุดุฑูุฉ ููุงููุง", "2084"), ("ุงูุดุฑูุฉ ุงูุณุนูุฏูุฉ ููููุฑุจุงุก", "5110")
    ],
    "ุงูุตูุงุฏูู ุงูุนูุงุฑูุฉ ุงููุชุฏุงููุฉ": [
        ("ุตูุฏูู ุงูุฑูุงุถ ุฑูุช", "4330"), ("ุตูุฏูู ุงูุฌุฒูุฑุฉ ุฑูุช", "4331"), ("ุตูุฏูู ุฌุฏูู ุฑูุช ุงูุญุฑููู", "4332"),
        ("ุตูุฏูู ุชุนููู ุฑูุช", "4333"), ("ุตูุฏูู ุงููุนุฐุฑ ุฑูุช", "4334"), ("ุตูุฏูู ูุดุงุฑูุฉ ุฑูุช", "4335"),
        ("ุตูุฏูู ููููุฉ ุนูุงุฑุงุช ุงูุฎููุฌ ุฑูุช", "4336"), ("ุตูุฏูู ุณููู ุงูุณุนูุฏูุฉ ุฑูุช", "4337"), ("ุตูุฏูู ุงูุฃููู ุฑูุช 1", "4338"),
        ("ุตูุฏูู ุฏุฑุงูุฉ ุฑูุช", "4339"), ("ุตูุฏูู ุงูุฑุงุฌุญู ุฑูุช", "4340"), ("ุตูุฏูู ุฌุฏูู ุฑูุช ุงูุณุนูุฏูุฉ", "4342"),
        ("ุตูุฏูู ุณุฏูู ูุงุจูุชุงู ุฑูุช", "4344"), ("ุตูุฏูู ุงูุฅููุงุก ุฑูุช ููุทุงุน ุงูุชุฌุฒุฆุฉ", "4345"), ("ุตูุฏูู ูููู ุฑูุช", "4346"),
        ("ุตูุฏูู ุจููุงู ุฑูุช", "4347"), ("ุตูุฏูู ุงูุฎุจูุฑ ุฑูุช", "4348"), ("ุตูุฏูู ุงูุฅููุงุก ุฑูุช ุงูููุฏูู", "4349"),
        ("ุตูุฏูู ุงูุฅุณุชุซูุงุฑ ุงุฑูู ุฑูุช ุงููุชููุน", "4350")
    ],
    "ุฅุฏุงุฑุฉ ูุชุทููุฑ ุงูุนูุงุฑุงุช": [
        ("ุงูุดุฑูุฉ ุงูุนูุงุฑูุฉ ุงูุณุนูุฏูุฉ", "4020"), ("ุดุฑูุฉ ุทูุจุฉ ููุฅุณุชุซูุงุฑ", "4090"), ("ุดุฑูุฉ ููุฉ ููุฅูุดุงุก ูุงูุชุนููุฑ", "4100"),
        ("ุดุฑูุฉ ุงูุฑูุงุถ ููุชุนููุฑ", "4150"),
        ("ุฅุนูุงุฑ ุงููุฏููุฉ ุงูุฅูุชุตุงุฏูุฉ", "4220"), ("ุดุฑูุฉ ุงูุจุญุฑ ุงูุฃุญูุฑ ุงูุนุงูููุฉ", "4230"), ("ุดุฑูุฉ ุฌุจู ุนูุฑ ููุชุทููุฑ", "4250"),
        ("ุดุฑูุฉ ุฏุงุฑ ุงูุฃุฑูุงู ููุชุทููุฑ ุงูุนูุงุฑู", "4300"),
        ("ูุฏููุฉ ุงููุนุฑูุฉ ุงูุฅูุชุตุงุฏูุฉ", "4310"), ("ุดุฑูุฉ ุงูุฃูุฏูุณ ุงูุนูุงุฑูุฉ", "4320"), ("ุดุฑูุฉ ุงููุฑุงูุฒ ุงูุนุฑุจูุฉ", "4321"),
        ("ุดุฑูุฉ ุฑุชุงู ููุชุทููุฑ ุงูุนูุฑุงูู", "4322"),
        ("ุดุฑูุฉ ุณูู ุงูุนูุงุฑูุฉ", "4323")
    ],
}

# Add missing sectors from previous code snippet (just copy all sectors you had in full):
# Make sure all the sectors with their stocks are included here as before.


# Combine all symbols
all_symbols = {'^TASI.SR': "ูุคุดุฑ ุงูุณูู ุงูุฑุฆูุณู ุชุฏุงูู (TASI)"}
for sym in base_symbols:
    all_symbols[sym.upper()] = sym.upper()
for sym, name in sp500_symbols:
    all_symbols[sym.upper()] = name
for sector, stocks in tadawul_sectors.items():
    for (name, code) in stocks:
        all_symbols[code + '.SR'] = name

def fetch_tadawul_data(ticker, interval, n_bars=5000):
    # Placeholder for Tadawul data
    return pd.DataFrame([])


# โโ Replace *only* fetch_yahoo_data with this version โโโโโโโโโ
def fetch_yahoo_data(ticker, interval,
                     ema_period=20, rsi_period=14,
                     include_ema=True, include_rsi=True,
                     include_sma50=False, include_sma200=False,
                     include_macd=False, include_stoch=False,
                     include_volume=False, include_bbands=False,
                     include_vwap=False):
    """
    Download OHLCV and calculate requested indicators.
    """
    end_date = datetime.now()
    if interval in ['1m', '5m']:
        start_date = end_date - timedelta(days=7)
    elif interval in ['15m', '60m']:
        start_date = end_date - timedelta(days=60)
    else:
        start_date = end_date - timedelta(days=365 * (10 if ticker.endswith('.SR') else 5))

    data = yf.download(ticker, start=start_date, end=end_date, interval=interval)
    if isinstance(data.columns, pd.MultiIndex):
        data.columns = data.columns.droplevel(1)
    if data.empty:
        return {k: [] for k in ('candlestick','ema','sma50','sma200','rsi','macd',
                                'stochrsi','volume','bbands','vwap')}

    # Indicators
    if include_ema:    data['EMA']   = ta.ema(data['Close'], length=ema_period)
    if include_sma50:  data['SMA50'] = ta.sma(data['Close'], length=50)
    if include_sma200: data['SMA200']= ta.sma(data['Close'], length=200)
    if include_rsi:    data['RSI']   = ta.rsi(data['Close'], length=rsi_period)
    if include_macd:
        macd = ta.macd(data['Close'])
        data['MACD'] = macd['MACD_12_26_9']
    if include_stoch:
        stoch = ta.stochrsi(data['Close'])
        data['STOCH'] = stoch['STOCHRSIk_14_14_3_3']
    if include_bbands:
        bb = ta.bbands(data['Close'], length=20, std=2)
        data['BBU'], data['BBL'] = bb['BBU_20_2.0'], bb['BBL_20_2.0']
    if include_vwap:
        data['VWAP'] = ta.vwap(high=data['High'], low=data['Low'],
                               close=data['Close'], volume=data['Volume'])

    # Build payload
    def ts(row): return int(row.Index.timestamp())
    payload = {
        'candlestick':[{'time':ts(r),'open':r.Open,'high':r.High,'low':r.Low,'close':r.Close}
                       for r in data.itertuples()],
        'ema'     :[{'time':ts(r),'value':r.EMA   } for r in data.itertuples() if include_ema   and pd.notna(r.EMA)],
        'sma50'   :[{'time':ts(r),'value':r.SMA50 } for r in data.itertuples() if include_sma50 and pd.notna(r.SMA50)],
        'sma200'  :[{'time':ts(r),'value':r.SMA200} for r in data.itertuples() if include_sma200 and pd.notna(r.SMA200)],
        'rsi'     :[{'time':ts(r),'value':r.RSI   } for r in data.itertuples() if include_rsi   and pd.notna(r.RSI)],
        'macd'    :[{'time':ts(r),'value':r.MACD  } for r in data.itertuples() if include_macd  and pd.notna(r.MACD)],
        'stochrsi':[{'time':ts(r),'value':r.STOCH } for r in data.itertuples() if include_stoch and pd.notna(r.STOCH)],
        'volume'  :[{'time':ts(r),'value':int(r.Volume)} for r in data.itertuples() if include_volume],
        'bbands'  :[{'time':ts(r),'upper':r.BBU,'lower':r.BBL}
                     for r in data.itertuples() if include_bbands and pd.notna(r.BBU) and pd.notna(r.BBL)],
        'vwap'    :[{'time':ts(r),'value':r.VWAP  } for r in data.itertuples() if include_vwap  and pd.notna(r.VWAP)],
    }
    return payload

@app.route('/')
def index():
    return render_template('index.html')

@app.route('/watchlist')
def watchlist_page():
    return render_template('watchlist.html')

@app.route('/about')
def about_page():
    return render_template('about.html')


@app.route('/signup', methods=['GET', 'POST'])
def signup():
    if request.method == 'POST':
        name = request.form.get('ุงูุฃุณู')
        email = request.form.get('ุงูุงูููู')
        if not name or not email:
            flash("ุงูุฑุฌุงุก ุฅุถุงูุฉ ุงูุงุณู ูุงูุจุฑูุฏ ุงูุฅููุชุฑููู.")
            return redirect(url_for('signup'))

        # Save to database
        new_user = User(name=name, email=email)
        db.session.add(new_user)
        db.session.commit()

        flash("ุชู ุงูุชุณุฌูู ุจูุฌุงุญ! ุณูุชู ุชุญูููู ุฅูู ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ...")
        return redirect(url_for('signup'))

    return render_template('signup.html')


# @app.route('/users')
# def users():
#    all_users = User.query.all()  # Fetch all users from the database
#    return render_template('users.html', users=all_users)


def send_welcome_email(email, name):
    # NOTE: This is a demo function. Replace with real SMTP credentials.
    # For demonstration, we will just print the email to console.
    # If you want to test actual sending, configure SMTP server.
    subject = "Welcome to TadawulHub"
    body = f"Hello {name},\n\nWelcome to TadawulHub!\nEnjoy exploring the platform.\n\nRegards,\nTadawulHub Team"
    print(f"Sending email to {email} with subject '{subject}' and body:\n{body}")
    # In production, you'd use smtplib or a mail service. Example:
    # msg = MIMEText(body)
    # msg['Subject'] = subject
    # msg['From'] = 'your_email@example.com'
    # msg['To'] = email
    # with smtplib.SMTP('localhost') as server:
    #     server.send_message(msg)

# โโ And change the /api/data route so it passes **all** toggles through โโ
@app.route('/api/data/<ticker>/<interval>/<int:ema_period>/<int:rsi_period>')
def get_data(ticker, interval, ema_period, rsi_period):
    params = dict(request.args)


    # ๐ FIX ticker formatting
    ticker = ticker.upper()
    if ticker == 'TASI':
        ticker = '^TASI.SR'
    elif not ticker.startswith('^') and not ticker.endswith('.SR'):
        ticker = ticker + '.SR'



    # tiny helper
    data = fetch_yahoo_data(
        ticker, interval,
        ema_period, rsi_period,
        include_ema      = params.get('ema')      == 'true',
        include_rsi      = params.get('rsi')      == 'true',
        include_sma50    = params.get('sma50')    == 'true',
        include_sma200   = params.get('sma200')   == 'true',
        include_macd     = params.get('macd')     == 'true',
        include_stoch    = params.get('stochrsi') == 'true',
        include_volume   = params.get('volume')   == 'true',
        include_bbands   = params.get('bbands')   == 'true',
        include_vwap     = params.get('vwap')     == 'true',
    )
    return jsonify(data)

@app.route('/api/symbols')
def get_symbols():
    symbols_list = []
    for s in all_symbols:
        display_symbol = s
        if display_symbol.endswith('.SR'):
            display_symbol = display_symbol[:-3]
        if display_symbol == '^TASI':
            display_symbol = '^TASI'
        symbols_list.append({'symbol': display_symbol, 'name': all_symbols[s]})
    return jsonify(symbols_list)

@app.route('/api/search_symbols/<query>')
def search_symbols(query):
    query = query.upper()
    results = []
    for sym, name in all_symbols.items():
        display_sym = sym
        if display_sym.endswith('.SR'):
            display_sym = display_sym[:-3]
        if display_sym == '^TASI':
            display_sym = '^TASI'
        if display_sym.startswith(query):
            results.append({'symbol': display_sym, 'name': name})
    results = results[:20]
    return jsonify(results)

@app.route('/api/tadawul_watchlist')
def tadawul_watchlist():
    output = {}
    # Include ^TASI under "Index" or a special sector
    output["Index"] = [{'code': 'TASI', 'name': "ูุคุดุฑ ุชุฏุงูู ููุณูู ุงูุฑุฆูุณู (TASI)"}]
    for sector, stocks in tadawul_sectors.items():
        output[sector] = []
        for (name, code) in stocks:
            output[sector].append({'code': code, 'name': name})
    return jsonify(output)

if __name__ == '__main__':
    app.run(debug=False)

